<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Examen de Certificación</title>
  <link rel="stylesheet" href="estilos.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <main>
    <h1>Examen JavaScript</h1>
    <div id="preguntas"></div>
    <button id="enviarBtn">Enviar</button>
  </main>

  <script>
    let examen = [];
    const token = localStorage.getItem("token");

    async function cargarExamen(){
      const res = await fetch("http://localhost:3000/api/examen/start", {
        method:"POST",
        headers: { Authorization:`Bearer ${token}` }
      });
      const data = await res.json();
      examen = data.examen;
      renderPreguntas();
    }

    function renderPreguntas(){
      const div = document.getElementById("preguntas");
      div.innerHTML = "";
      examen.forEach((p,i)=>{
        div.innerHTML += `
          <div>
            <p><b>${i+1}. ${p.pregunta}</b></p>
            ${p.opciones.map(o => `<label><input type="radio" name="p${p.id}" value="${o}"> ${o}</label><br>`).join('')}
          </div>
        `;
      });
    }

    document.getElementById("enviarBtn").onclick = async ()=>{
      const respuestas = examen.map(p=>{
        const seleccion = document.querySelector(`input[name="p${p.id}"]:checked`);
        return { id:p.id, respuesta: seleccion?.value || "" };
      });

      const res = await fetch("http://localhost:3000/api/examen/submit", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          Authorization:`Bearer ${token}`
        },
        body: JSON.stringify({ respuestas })
      });
      const data = await res.json();

      if(data.aprobado){
        Swal.fire("¡Felicidades!","Aprobaste con "+data.calificacion+"%","success");
      } else {
        Swal.fire("Resultado","Reprobaste con "+data.calificacion+"%","error");
      }
    }

    cargarExamen();
  </script>
</body>
</html>
